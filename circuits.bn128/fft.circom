pragma circom 2.1.0;

include "gl.circom";
include "bitify.circom";


function roots(i) {
    var roots[33] = [
        1,
        18446744069414584320,
        281474976710656,
        18446744069397807105,
        17293822564807737345,
        70368744161280,
        549755813888,
        17870292113338400769,
        13797081185216407910,
        1803076106186727246,
        11353340290879379826,
        455906449640507599,
        17492915097719143606,
        1532612707718625687,
        16207902636198568418,
        17776499369601055404,
        6115771955107415310,
        12380578893860276750,
        9306717745644682924,
        18146160046829613826,
        3511170319078647661,
        17654865857378133588,
        5416168637041100469,
        16905767614792059275,
        9713644485405565297,
        5456943929260765144,
        17096174751763063430,
        1213594585890690845,
        6414415596519834757,
        16116352524544190054,
        9123114210336311365,
        4614640910117430873,
        1753635133440165772
    ];
    return roots[i];
}

function invroots(i) {
    var invroots[33] = [
        1,
        18446744069414584320,
        18446462594437873665,
        1099511627520,
        68719476736,
        18446744069414322177,
        18302628881338728449,
        18442240469787213841,
        2117504431143841456,
        4459017075746761332,
        4295002282146690441,
        8548973421900915981,
        11164456749895610016,
        3968367389790187850,
        4654242210262998966,
        1553425662128427817,
        7868944258580147481,
        14744321562856667967,
        2513567076326282710,
        5089696809409609209,
        17260140776825220475,
        11898519751787946856,
        15307271466853436433,
        5456584715443070302,
        1219213613525454263,
        13843946492009319323,
        16884827967813875098,
        10516896061424301529,
        4514835231089717636,
        16488041148801377373,
        16303955383020744715,
        10790884855407511297,
        8554224884056360729
    ];
    return invroots[i];
}

template FFT(nBits, inv) {

    var p = 0xFFFFFFFF00000001;
    var N = 1<<nBits;

    signal input in[N][3];
    signal output out[N][3];

    signal k[N][3];

    var w;
    var ws[N];
    if (inv) {
        w = invroots(nBits);
        ws[0] = _inv1(N);
    } else {
        w = roots(nBits);
        ws[0] = 1;
    }
    for (var i=1; i<N; i++) {
        ws[i] = ( ws[i-1] * w ) % p;
    }

    var sum[N][3];
    for (var i=0; i<N; i++) {
        for (var e=0; e<3; e++) {
            sum[i][e] = 0;
            for (var j=0; j<N; j++) {
                sum[i][e] = sum[i][e] + ws[(i*j)%N]* in[j][e];
            }
        }
    }

    component n2bK[N][3];
    component n2bO[N][3];
    for (var i=0; i<N; i++) {
        for (var e=0; e<3; e++) {
            k[i][e] <-- sum[i][e] \ p;
            out[i][e] <-- sum[i][e] % p;

            k[i][e]*p + out[i][e] === sum[i][e];

            n2bK[i][e] = Num2Bits(64+nBits+1);
            n2bK[i][e].in <== k[i][e];
            _ <== n2bK[i][e].out;

            n2bO[i][e] = Num2Bits(64);
            n2bO[i][e].in <== out[i][e];
	        _ <== n2bO[i][e].out;
        }
    }
}
